// services/ipWhitelist.ts

/**
 * 將 IPv4 字串轉換為 32 位元整數。
 */
const ipToLong = (ip: string): number => {
  return ip.split('.').reduce((acc, octet, index) => {
    return acc + (parseInt(octet, 10) << (24 - index * 8));
  }, 0) >>> 0; // 使用 >>> 0 確保是無符號整數
};

/**
 * 檢查 IP 是否在 CIDR 範圍內。
 * @param ip - 使用者的 IP 字串 (e.g., "140.113.1.1")
 * @param cidr - CIDR 範圍字串 (e.g., "140.113.0.0/16")
 * @returns boolean - 是否在範圍內
 */
const isIpInCidr = (ip: string, cidr: string): boolean => {
  try {
    const [range, bitsStr] = cidr.split('/');
    const bits = parseInt(bitsStr, 10);
    
    // 建立子網路遮罩
    const mask = (0xFFFFFFFF << (32 - bits)) >>> 0;

    const longIp = ipToLong(ip);
    const longRange = ipToLong(range);

    return (longIp & mask) === (longRange & mask);
  } catch (e) {
    console.error(`Error checking IP ${ip} against CIDR ${cidr}:`, e);
    return false;
  }
};

// 台灣學術網路 (TANet) 主要 IP 範圍 (範例列表)
// 您應根據 https://life.nthu.edu.tw/~fmhsu/network/tanet-ip.htm 或教育部官方公告 擴充此列表
const TANET_RANGES: string[] = [
  // 主要大學 (140.109 ~ 140.138)
  "140.109.0.0/16", // 中研院
  "140.110.0.0/16", //
  "140.111.0.0/16", // 教育部
  "140.112.0.0/16", // 台灣大學
  "140.113.0.0/16", // 交通大學 (陽明交大)
  "140.114.0.0/16", // 清華大學
  "140.115.0.0/16", // 中央大學
  "140.116.0.0/16", // 成功大學
  "140.117.0.0/16", // 中山大學
  "140.118.0.0/16", // 中正大學
  "140.119.0.0/16", // 台灣科技大學
  "140.120.0.0/16", // 臺灣師範大學
  "140.121.0.0/16", // 中興大學
  "140.122.0.0/16",
  "140.123.0.0/16",
  "140.124.0.0/16", // 台北科技大學
  "140.125.0.0/16",
  "140.126.0.0/16",
  "140.127.0.0/16",
  "140.128.0.0/16",
  "140.129.0.0/16",
  "140.130.0.0/16", // 您之前提到的 (例如：大同商專)
  "140.131.0.0/16", // 德明財經科技大學
  "140.132.0.0/16",
  "140.133.0.0/16",
  "140.134.0.0/16",
  "140.135.0.0/16",
  "140.136.0.0/16",
  "140.137.0.0/16",
  "140.138.0.0/16",
  
  // 技職體系 (163.13 ~ 163.32)
  "163.13.0.0/16",
  "163.14.0.0/16",
  // ... (中略) ...
  "163.20.0.0/16",
  "163.21.0.0/16",
  "163.22.0.0/16",
  "163.23.0.0/16",
  "163.24.0.0/16",
  "163.25.0.0/16",
  "163.26.0.0/16",
  "163.27.0.0/16",
  "163.28.0.0/16",
  "163.29.0.0/16",
  "163.30.0.0/16",
  "163.31.0.0/16",
  "163.32.0.0/16",

  // 縣市教育網路中心 (210.xx, 203.xx)
  "203.64.0.0/11",  // 203.64.0.0 - 203.95.255.255
  "203.71.0.0/16",
  "203.72.0.0/16",
  "210.60.0.0/16",
  "210.61.0.0/16",
  "210.70.0.0/16",
  "210.71.0.0/16",
  "210.240.0.0/16",
  
  // 舊有 (192.x)
  "192.83.0.0/16",
  "192.192.0.0/16", // 立法院, 國防醫學院
  
  // 其他區網 (120.x)
  "120.96.0.0/16", // 亞東科技大學
  "120.97.0.0/16" // 國立臺北護理健康大學
];


/**
 * 檢查 IP 是否可疑 (即不在 TANet 白名單中)。
 * @param currentIp - 當前使用者的 IP
 * @returns boolean - 如果 IP *不在* TANet 列表中，則為 true (可疑)
 */
export const isIpSuspicious = (currentIp: string | null): boolean => {
  if (!currentIp) {
    // 如果無法獲取 IP，為安全起見，視為可疑。
    return true;
  }
  
  // 檢查 IP 是否在任何一個 TANet 範圍內
  for (const cidr of TANET_RANGES) {
    if (isIpInCidr(currentIp, cidr)) {
      return false; // 找到匹配，IP 安全 (不是可疑的)
    }
  }

  // 遍歷所有範圍後都未找到，IP 可疑
  return true;
};
